<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Coder ç°æ¡‘"/><link rel="canonical" href="https://coder.linsyorozuya.com/posts/SwiftUI%20Widget%20%E4%BD%BF%E7%94%A8%20CloudKit%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE"/><meta name="twitter:url" content="https://coder.linsyorozuya.com/posts/SwiftUI%20Widget%20%E4%BD%BF%E7%94%A8%20CloudKit%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE"/><meta name="og:url" content="https://coder.linsyorozuya.com/posts/SwiftUI%20Widget%20%E4%BD%BF%E7%94%A8%20CloudKit%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE"/><title>ç‹¬ç«‹å¼€å‘æ—¥è®°ï¼šWidget ä½¿ç”¨ CloudKit ä¸­çš„æ•°æ® | Coder ç°æ¡‘</title><meta name="twitter:title" content="ç‹¬ç«‹å¼€å‘æ—¥è®°ï¼šWidget ä½¿ç”¨ CloudKit ä¸­çš„æ•°æ® | Coder ç°æ¡‘"/><meta name="og:title" content="ç‹¬ç«‹å¼€å‘æ—¥è®°ï¼šWidget ä½¿ç”¨ CloudKit ä¸­çš„æ•°æ® | Coder ç°æ¡‘"/><meta name="description" content="Stay Foolish, Always Foolish"/><meta name="twitter:description" content="Stay Foolish, Always Foolish"/><meta name="og:description" content="Stay Foolish, Always Foolish"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Coder ç°æ¡‘"/></head><body class="item-page"><header><div class="wrapper"><a href="/" class="site-name">Coder ç°æ¡‘</a><p class="description">Stay Foolish, Always Foolish</p><nav><ul><li><a href="/">æœ€æ–°</a></li><li class="selected"><a href="/posts">Code</a></li><li><a href="/products">äº§å“</a></li><li><a href="/about">å…³äº</a></li></ul></nav></div></header><div class="wrapper"><article><h1>ç‹¬ç«‹å¼€å‘æ—¥è®°ï¼šWidget ä½¿ç”¨ CloudKit ä¸­çš„æ•°æ®</h1><div class="metadata"><ul class="tag-list"><li class="tag variant-0"><a href="/tags/ios">iOS</a></li><li class="tag variant-7"><a href="/tags/ç‹¬ç«‹å¼€å‘">ç‹¬ç«‹å¼€å‘</a></li></ul><span class="date">7æœˆ 24, 2021</span></div><div class="content"><blockquote><p>æœ‰æ—¶å€™æƒ³åœ¨ Widget ä¸Šæ˜¾ç¤º CloudKit ä¸­çš„æ•°æ®ï¼Œå¦‚æœç›´æ¥åœ¨ Widget ä¸­é€šè¿‡ Container å»è·å–æ•°æ®æ˜¯è·å–ä¸åˆ°çš„ã€‚</p></blockquote><h3>å¼€å¯ CloudKit</h3><img src="https://cdn.jsdelivr.net/gh/linsyorozuya/Pics@master/uPic/newProjWithCloudkit.png" alt="æ–°å»ºå·¥ç¨‹"/><p>ç›®å‰åœ¨æ–°å»ºå·¥ç¨‹æ—¶ï¼Œå¦‚æœé’©ä¸Š Use Core Data å’Œ Host in CloudKitåï¼Œå·¥ç¨‹ä¼šé»˜è®¤ç”Ÿæˆ Persistence.swift å’Œ å·¥ç¨‹å.xcdatamodeld ä¸¤ä¸ªæ–‡ä»¶ã€‚æŸ¥çœ‹ Persistence.swift å¯ä»¥å‘ç°æ˜¯ä½¿ç”¨äº† NSPersistentCloudKitContainer æ¥è¿›è¡Œæœ¬åœ° Core Data å’Œ CloudKit æ•°æ®çš„åŒæ­¥å’Œç¼“å­˜ã€‚é»˜è®¤çš„ Core Data ä¿å­˜æ•°æ®çš„æ–‡ä»¶åœ°å€åœ¨ container.persistentStoreDescriptions.firstã€‚è¿™ä¸ªåœ°å€çš„æ•°æ®å¹¶ä¸ä¼šå’Œ Widget è¿›è¡Œå…±äº«çš„ã€‚æ‰€ä»¥åœ¨ åœ¨ Widget ä¸­é€šè¿‡ NSPersistentCloudKitContainer æ˜¯è·å–ä¸åˆ°æ•°æ®çš„ã€‚</p><h3>App Group</h3><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒApple æä¾›äº† App Group å…è®¸å•ä¸ªå¼€å‘å›¢é˜Ÿç”Ÿæˆçš„å¤šä¸ªåº”ç”¨ç¨‹åºè®¿é—®å…±äº«å®¹å™¨å¹¶ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡ (IPC) è¿›è¡Œé€šä¿¡ã€‚åº”ç”¨ç¨‹åºå¯èƒ½å±äºä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºç»„ã€‚ å¼€å¯ App Group åªè¦åœ¨ Capabilities ä¸­æ·»åŠ  App Group å³å¯ã€‚</p><h3>å˜æ›´ CloudKit æœ¬åœ°æ•°æ®åœ°å€</h3><p>App Group å¯ä»¥å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆè§£å†³æ–¹æ³•å°±æ˜¯æŠŠ CloudKit çš„æœ¬åœ°æ•°æ®æ–‡ä»¶é»˜è®¤åœ°å€ï¼Œæ”¾åˆ° App Group æ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸‹ã€‚</p><h4>Cloud æ•°æ®æœªå‘å¸ƒåˆ°æ­£å¼ç¯å¢ƒ</h4><p>å› ä¸ºæ•°æ®æœªå‘å¸ƒåˆ°æ­£å¼ç¯å¢ƒï¼Œæ‰€ä»¥å¼€å‘æ•°æ®æ²¡é‚£ä¹ˆé‡è¦ï¼Œåªè¦åœ¨ Persistence.swift ä¸­åˆå§‹åŒ– NSPersistentCloudKitContainer æ—¶é…ç½® NSPersistentStoreDescription Url åˆ° App Group æ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸‹ï¼š</p><pre><code><span class="keyword">let</span> container = <span class="type">NSPersistentContainer</span>(name: <span class="string">"World"</span>)

<span class="keyword">let</span> storeURL = <span class="type">AppGroup</span>.<span class="property">facts</span>.<span class="property">containerURL</span>.<span class="call">appendingPathComponent</span>(<span class="string">"World.sqlite"</span>)
<span class="keyword">let</span> description = <span class="type">NSPersistentStoreDescription</span>(url: storeURL)
<span class="comment">/// 1âƒ£ï¸</span>
description.<span class="property">cloudKitContainerOptions</span> = <span class="type">NSPersistentCloudKitContainerOptions</span>(containerIdentifier: <span class="string">"iCloud.com.xxxx.World"</span>)
container.<span class="property">persistentStoreDescriptions</span> = [description]

container.<span class="call">loadPersistentStores</span> { ... }
</code></pre><h4>Cloud æ•°æ®å·²ç»å‘å¸ƒåˆ°æ­£å¼ç¯å¢ƒ</h4><p>å› ä¸ºæ•°æ®å·²å‘å¸ƒåˆ°æ­£å¼ç¯å¢ƒï¼Œæ‰€ä»¥æ•°æ®æ˜¯ä¸å…è®¸ä¸¢å¤±çš„ã€‚å› æ­¤åªèƒ½å°†æ•°æ®åº“è¿ç§»ã€‚åœ¨ loadPersistentStores å®Œæˆåï¼Œé€šè¿‡ migratePersistentStore å°†æ•°æ®åº“è¿ç§»åˆ°æ–°çš„ App Group çš„åœ°å€ï¼š</p><pre><code>container = <span class="type">NSPersistentCloudKitContainer</span>(name: <span class="string">"World"</span>)

<span class="comment">/// è¿ç§» coredata å¹¶ cloudkit</span>
<span class="keyword">var</span> defaultURL: <span class="type">URL</span>?
<span class="keyword">if let</span> storeDescription = container.<span class="property">persistentStoreDescriptions</span>.<span class="property">first</span>, <span class="keyword">let</span> url = storeDescription.<span class="property">url</span> {
    defaultURL = <span class="type">FileManager</span>.<span class="property">default</span>.<span class="call">fileExists</span>(atPath: url.<span class="property">path</span>) ? url : <span class="keyword">nil</span>
}

<span class="keyword">let</span> storeURL = <span class="type">AppGroup</span>.<span class="property">world</span>.<span class="property">containerURL</span>.<span class="call">appendingPathComponent</span>(<span class="string">"World.sqlite"</span>)
<span class="keyword">if</span> defaultURL == <span class="keyword">nil</span> {
    <span class="keyword">let</span> description = <span class="type">NSPersistentStoreDescription</span>(url: storeURL)
	  <span class="comment">/// 1âƒ£ï¸</span>
    description.<span class="property">cloudKitContainerOptions</span> = <span class="type">NSPersistentCloudKitContainerOptions</span>(containerIdentifier: <span class="string">"iCloud.com.xxxx.World"</span>)
    container.<span class="property">persistentStoreDescriptions</span> = [description]
}

container.<span class="call">loadPersistentStores</span>(completionHandler: { [<span class="keyword">unowned</span> container] <span class="keyword">_</span>, error <span class="keyword">in

    if let</span> error = error <span class="keyword">as</span> <span class="type">NSError</span>? {
        <span class="preprocessing">#if DEBUG</span>
        <span class="call">fatalError</span>(<span class="string">"Unresolved error</span> \(error)<span class="string">,</span> \(error.<span class="property">userInfo</span>)<span class="string">"</span>)
        <span class="preprocessing">#endif</span>
    }

    <span class="keyword">if let</span> url = defaultURL, url.<span class="property">absoluteString</span> != storeURL.<span class="property">absoluteString</span> {
        <span class="keyword">let</span> coordinator = container.<span class="property">persistentStoreCoordinator</span>
        <span class="keyword">if let</span> oldStore = coordinator.<span class="call">persistentStore</span>(for: url) {
            <span class="keyword">do</span> {
                <span class="keyword">try</span> coordinator.<span class="call">migratePersistentStore</span>(oldStore, to: storeURL, options: <span class="keyword">nil</span>, withType: <span class="type">NSSQLiteStoreType</span>)
            } <span class="keyword">catch</span> {
                <span class="call">print</span>(error.<span class="property">localizedDescription</span>)
            }

            <span class="comment">// delete old store</span>
            <span class="keyword">let</span> fileCoordinator = <span class="type">NSFileCoordinator</span>(filePresenter: <span class="keyword">nil</span>)
            fileCoordinator.<span class="call">coordinate</span>(writingItemAt: url, options: .<span class="dotAccess">forDeleting</span>, error: <span class="keyword">nil</span>, byAccessor: { url <span class="keyword">in
                do</span> {
                    <span class="keyword">try</span> <span class="type">FileManager</span>.<span class="property">default</span>.<span class="call">removeItem</span>(at: url)
                } <span class="keyword">catch</span> {
                    <span class="call">print</span>(error.<span class="property">localizedDescription</span>)
                }
            })
        }
    }
})
</code></pre><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ 1âƒ£ï¸ ä½ç½®çš„ä»£ç ï¼Œå› ä¸ºæ–°çš„ NSPersistentStoreDescription é»˜è®¤æ˜¯æ²¡æœ‰é…ç½® CloudKit æ•°æ®åº“ï¼Œä¸ä¼šè¿›è¡ŒåŒæ­¥ã€‚æ‰€ä»¥éœ€è¦é…ç½® cloudKitContainerOptions æ‰èƒ½æ­£å¸¸è¿›è¡Œ Cloud çš„æ•°æ®åŒæ­¥ã€‚</p><p>å‚è€ƒï¼š <a href="https://useyourloaf.com/blog/sharing-data-with-a-widget/">Sharing data with a Widget</a></p></div></article></div><div class="item-bottom-nav"><div></div><div><a href="/products/DailyApod" class="item">DailyApodÂ  ğŸ”œ</a></div></div><footer><p>Copyright Â© 2021 ç°æ¡‘</p><p>Powered by <a href="https://github.com/johnsundell/publish">John Sundell's Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>