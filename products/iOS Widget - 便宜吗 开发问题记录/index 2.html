<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Coder 灰桑"/><link rel="canonical" href="https://coder.linsyorozuya.com/products/iOS%20Widget%20-%20%E4%BE%BF%E5%AE%9C%E5%90%97%20%E5%BC%80%E5%8F%91%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"/><meta name="twitter:url" content="https://coder.linsyorozuya.com/products/iOS%20Widget%20-%20%E4%BE%BF%E5%AE%9C%E5%90%97%20%E5%BC%80%E5%8F%91%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"/><meta name="og:url" content="https://coder.linsyorozuya.com/products/iOS%20Widget%20-%20%E4%BE%BF%E5%AE%9C%E5%90%97%20%E5%BC%80%E5%8F%91%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"/><title>iOS Widget - 便宜吗 开发问题记录 | Coder 灰桑</title><meta name="twitter:title" content="iOS Widget - 便宜吗 开发问题记录 | Coder 灰桑"/><meta name="og:title" content="iOS Widget - 便宜吗 开发问题记录 | Coder 灰桑"/><meta name="description" content="很久很久以前…淘宝是有价格变化曲线的，利用曲线可以很大程度上防止商家的虚假促销。但是不知到出于什么原因后来取消了这个功能。"/><meta name="twitter:description" content="很久很久以前…淘宝是有价格变化曲线的，利用曲线可以很大程度上防止商家的虚假促销。但是不知到出于什么原因后来取消了这个功能。"/><meta name="og:description" content="很久很久以前…淘宝是有价格变化曲线的，利用曲线可以很大程度上防止商家的虚假促销。但是不知到出于什么原因后来取消了这个功能。"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Coder 灰桑"/></head><body class="item-page"><header><div class="wrapper"><a href="/" class="site-name">Coder 灰桑</a><p class="description">Stay Foolish, Always Foolish</p><nav><ul><li><a href="/">最新</a></li><li><a href="/posts">Code</a></li><li class="selected"><a href="/products">产品</a></li><li><a href="/about">关于</a></li></ul></nav></div></header><div class="wrapper"><article><h1>iOS Widget - 便宜吗 开发问题记录</h1><div class="metadata"><ul class="tag-list"><li class="tag variant-5"><a href="/tags/widget">Widget</a></li><li class="tag variant-0"><a href="/tags/ios">iOS</a></li></ul><span class="date">1月 9, 2017</span></div><div class="content"><img src="https://cdn.jsdelivr.net/gh/linsyorozuya/Pics@master/uPic/---.png"/><p>WHY ---</p><p>很久很久以前…</p><p>淘宝是有价格变化曲线的，利用曲线可以很大程度上防止商家的虚假促销。但是不知到出于什么原因后来取消了这个功能。</p><p>庆幸的是浏览器上目前还有几款插件来显示历史价格，不幸的是手机上并没有。</p><p>只发现一款叫 <code>比一比价</code> 的 app 提供了这个功能（没有开发 widget），而且能查询大部分电商商品的价格曲线。</p><p>虽然可以查询，但是这个 app 的搜索过程繁琐，要是想查询一个商品的价格，你需要四个步骤：</p><ul><li>复制商品的衔接</li><li>打开 app</li><li>黏贴 链接</li><li>点击搜索</li></ul><p>可是我喜欢那种 Pin 和 TodayMind 那种无需打开 app 只需下拉通知栏就能使用的的快捷方式 @。@，所以我想要的步骤是：</p><ul><li>复制商品链接</li><li>下拉通知栏</li></ul><p>所以来了兴趣想自己写个 widget, 也学习下了解下通知栏的开发~</p><p><strong>（开发使用的是 <code>比一比价</code> 手机端使用的查询接口。由于数据不全，也就没做显示价格曲线的功能了）</strong></p><p>这个 APP 叫<code>便宜吗</code>，顺便也瞎弄了个图标~ <img src="https://cdn.jsdelivr.net/gh/linsyorozuya/Pics@master/uPic/IsRealCheap.png" alt="icon"/></p><p>看使用效果：</p><img src="https://cdn.jsdelivr.net/gh/linsyorozuya/Pics@master/uPic/---.gif"/><p>官方文档关于 Today Extention 的篇幅不大。基本的要用的方法都讲到，然后再看看其他人的文章就可以开始入手了。（可以参考文章底部引用的两个链接地址。）</p><p>便宜吗的功能实现上很简单，主要就三个步骤：</p><ol><li>获取系统剪贴板上的链接：</li><li>利用链接请求数据</li><li>将数据显示到控件上</li></ol><p>当然还有一些细节处理，比如保存上次搜索的历史记录、如果地址相同显示上次搜索的数据等等。</p><p>这里主要记录下开发中遇到的一些问题（基于 iOS 10）：</p><ul><li><strong>高度问题</strong>：iOS 10 后 widget 高度有两种模式：折叠和展开。 折叠模式的最小高度是 110，但也是这种模式下的最大高度。对的，不能更改 @。@。 展开模式有最大高度的限制，根据设备的不同最大高度也是不同。</li></ul><p>设置扩展模式需要添加以下代码：</p><pre><code>- (void)<span class="call">viewDidLoad</span> {
    [<span class="keyword">super</span> viewDidLoad];
    
    <span class="keyword">self</span>.<span class="property">extensionContext</span>.<span class="property">widgetLargestAvailableDisplayMode</span> = <span class="type">NCWidgetDisplayModeExpanded</span>;
}

#pragma mark - 切换展开和折叠的模式执行的方法
- (void)widgetActiveDisplayModeDidChange:(<span class="type">NCWidgetDisplayMode</span>)activeDisplayMode withMaximumSize:(<span class="type">CGSize</span>)<span class="call">maxSize</span>
{
    <span class="keyword">if</span> (activeDisplayMode == <span class="type">NCWidgetDisplayModeCompact</span>) {
        <span class="keyword">self</span>.<span class="property">preferredContentSize</span> = maxSize;
    }<span class="keyword">else</span>
    {
		  
        <span class="keyword">self</span>.<span class="property">preferredContentSize</span> = <span class="type">CGSizeMake</span>(maxSize.<span class="property">width</span>, <span class="number">300</span>);
    }
}
</code></pre><ul><li><strong>背景色问题</strong>：默认的 widget 本景色是一个有些毛玻璃效果的白色。你如果试图改变成其他颜色的话，目前我发现的一个问题是 widget 底部两个圆角，在下拉通知栏的时候都是直角，通知栏下拉完全后，会有个直角变成默认的圆角的突变。目前我的解决办法是添加圆角来处理（测试圆角为 15 ）。=。=</li></ul><pre><code>- (void)addCornerRadius:(<span class="type">CGSize</span>)<span class="call">radius</span>
{
    
    <span class="type">UIBezierPath</span> *maskPath = [<span class="type">UIBezierPath</span> bezierPathWithRoundedRect:<span class="type">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, _contentContainerView.<span class="property">bounds</span>.<span class="property">size</span>.<span class="property">width</span>,_contentContainerView.<span class="property">bounds</span>.<span class="property">size</span>.<span class="property">height</span>) byRoundingCorners:<span class="type">UIRectCornerBottomLeft</span> | <span class="type">UIRectCornerBottomRight</span> cornerRadii:radius];
    <span class="type">CAShapeLayer</span> *maskLayer = [[<span class="type">CAShapeLayer</span> alloc] <span class="keyword">init</span>];
    maskLayer.<span class="property">frame</span> = _contentContainerView.<span class="property">bounds</span>;
    maskLayer.<span class="property">path</span> = maskPath.<span class="type">CGPath</span>;
    _contentContainerView.<span class="property">layer</span>.<span class="property">mask</span> = maskLayer;
}

</code></pre><ul><li><strong>数据问题</strong>：如果你想在 widget 中，添加一个全局变量来保存临时数据是不可行的。每次下拉通知栏后，所有数据都会清空。相当于每次下拉通知栏，所有的 widget 的生命周期又重新开始。收起通知栏所有 widget 生命周期结束。所以如果要保存上次的变量，可以用 NSUserDefaults 的方法来保存。</li></ul><p>总结 --</p><p>widget 开发还是要看需求是否符合 widget 的使用场景。由于高度的限制，其实更能去思考开发的核心功能是什么。如何充分利用 110 的空间去做一些便捷实用的事情，也许才是开发 widget 开发真正思考的事情吧。</p><p><a href="https://github.com/linsyorozuya/IsRealCheap">代码地址 GitHub</a></p><h5>额~：</h5><p><code>之前询问过 manmanbuy.com 能否使用相关接口，被否定后我建议他们做个相似的插件查询价格。后来真的做了并且已上线叫 历史价格查询。有这方面需求的可以去下载这个软件。</code></p><p><strong>相关链接：</strong></p><ul><li><a href="http://www.jianshu.com/p/ca3e11d7686c">iOS 开发之 widget 实现</a></li><li><a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/Today.html#//apple_ref/doc/uid/TP40014214-CH11-SW1">App Extension Programming Guide: Today</a></li></ul></div></article></div><div class="item-bottom-nav"><div><a href="/products/lyricsBook" class="item">🔙  「歌词派」</a></div><div><a href="/posts/iOS 自定义控件适应内容大小问题" class="item">iOS 自定义控件适应内容大小问题  🔜</a></div></div><footer><p>Copyright © 2021 灰桑</p><p>Powered by <a href="https://github.com/johnsundell/publish">John Sundell's Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>